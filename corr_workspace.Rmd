---
title: "corr_workspace"
author: "Zack Grzywacz"
date: "October 30, 2020"
output: html_document
---


Not sure if i need all of these
```{r}
library(ncdf4)
library(raster)
library(lubridate)
library(ggplot2)
library(lattice)
library(rnaturalearth)
library(rnaturalearthdata)
library(rasterVis)
library(viridis)
library(seas)
library(s2dverification)
library(reshape2)
library(dplyr)
```



### Data Download from ECHAM5‚Äêwiso (monthly, 1 degree grid)
https://zenodo.org/record/1249604#.XpnVbFNKhTZ

Data sources, years, extent (could be variables in function call someday)
SH extent can be changed to include pacific ocean, etc

!!!! Change this so it opens all of the files (apply?)
Change the years?
Changed to TAS extent. WILL HAVE TO REPEAT for SH extent (or just Indian Ocean)
```{r}
d18o.file <- "data/d18O_precip_mon_1871_2011.nc"
evap.file <- "data/evap_mon_1871_2011.nc"
precip.file <- "data/precip_mon_1871_2011.nc"
ps.file <- "data/ps_mon_1871_2011.nc"
qvi.file <- "data/qvi_mon_1871_2011.nc"
relhum.file <- "data/relhum_mon_1871_2011.nc"
slp.file <- "data/slp_mon_1871_2011.nc"
t2m.file <- "data/t2m_mon_1871_2011.nc"
wind10.file <- "data/wind10_mon_1871_2011.nc"
  
F_yr <- 1958
L_yr <- 2011
years <- seq(F_yr, L_yr)
ext <- extent(143.5, 148.6, -43.8, -39.5) 
#ext <- extent(0, 180, -90, 0) #SH extent
#ext <- extent(143.5, 148.6, -43.8, -39.5) #TAS Extent
```


```{r}
echam_read <- function(x) {
  nc <- ncdf4::nc_open(x)
  var.name <- names(nc[['var']])[1]
  ncdf4::nc_close(nc)
 dat <- rotate(brick(x, varname= var.name))
 datC <- crop(dat, ext)
  return(datC)
}

```

Do this for all files. Change file name in both lines

```{r}
datFile <- echam_read(wind10.file)
saveRDS(datFile, file = "wind10.rds")
```

!!!All files are in Rdata

confirm that the time origin and units are appropriate......
(Units will be different for different files)
```{r}
nc <- ncdf4::nc_open(d18o.file)

#select the variable
var.name <- names(nc[['var']])[1] #be sure this is the value you want

summary(nc$dim$lon$vals) #if longitude is 0-360 needs to be rotated
tunits <- ncdf4::ncatt_get(nc, "time", "units")
print(tunits)

ncdf4::nc_close(nc)
```


To save multiple R objects to one file (May not want to do this)

```{r}
# Saving on object in RData format
save(data1, file = "data.RData")
# Save multiple objects
save(data1, data2, file = "data.RData")
# To load the data again
load("data.RData") #Nope. readRDS()
```

```{r}
d18o <- readRDS("Rdata/d18o.rds")
ps <- readRDS("Rdata/ps.rds")
```


This is just a single variable over time
```{r}
time <- 1:nlayers(d18o)
fun <- function(x) { lm(x ~ time)$coefficients[2] }
x <- calc(d18o, fun)
plot(x)
```

Two variables: 
-Perform this for each variable with d18o
```{r}
corrs <- corLocal(evap, relhum, method = "pearson")
plot(corrs)
```

next steps:
-Experiment with this function/other functions
-Extract values for point at MRD
-Determine which influence the most, and use what we know about d18o to see if that makes sense
-Turn into multple variable regression? Maybe unnecessary
-Turn into moving-window (part 2)








