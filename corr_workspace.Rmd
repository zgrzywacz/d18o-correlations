---
title: "corr_workspace"
author: "Zack Grzywacz"
date: "October 30, 2020"
output: html_document
---


```{r}
install.packages("Hmisc")
```


Not sure if i need all of these
```{r}
library(ncdf4)
library(raster)
library(lubridate)
library(ggplot2)
library(lattice)
library(rnaturalearth)
library(rnaturalearthdata)
library(rasterVis)
library(viridis)
library(seas)
library(s2dverification)
library(reshape2)
library(dplyr)
library(Hmisc)
```



### Data Download from ECHAM5‚Äêwiso (monthly, 1 degree grid)
https://zenodo.org/record/1249604#.XpnVbFNKhTZ

Data sources, years, extent (could be variables in function call someday)
SH extent can be changed to include pacific ocean, etc

!!!! Change this so it opens all of the files (apply?)
Change the years?
Changed to TAS extent. WILL HAVE TO REPEAT for SH extent (or just Indian Ocean)
#ext <- extent(50, 150, -75, 0)
```{r}
d18o.file <- "data/d18O_precip_mon_1871_2011.nc"
evap.file <- "data/evap_mon_1871_2011.nc"
precip.file <- "data/precip_mon_1871_2011.nc"
ps.file <- "data/ps_mon_1871_2011.nc"
qvi.file <- "data/qvi_mon_1871_2011.nc"
relhum.file <- "data/relhum_mon_1871_2011.nc"
slp.file <- "data/slp_mon_1871_2011.nc"
t2m.file <- "data/t2m_mon_1871_2011.nc"
wind10.file <- "data/wind10_mon_1871_2011.nc"
  
F_yr <- 1958
L_yr <- 2011
years <- seq(F_yr, L_yr)
ext <- extent(143.5, 148.6, -43.8, -39.5) 
#ext <- extent(0, 180, -90, 0) #SH extent
#ext <- extent(143.5, 148.6, -43.8, -39.5) #TAS Extent
```


```{r}
echam_read <- function(x) {
  nc <- ncdf4::nc_open(x)
  var.name <- names(nc[['var']])[1]
  ncdf4::nc_close(nc)
 dat <- rotate(brick(x, varname= var.name))
 datC <- crop(dat, ext)
  return(datC)
}

```

Do this for all files. Change file name in both lines

```{r}
datFile <- echam_read(wind10.file)
saveRDS(datFile, file = "wind10.rds")
```

!!!All files are in Rdata

confirm that the time origin and units are appropriate......
(Units will be different for different files)
```{r}
nc <- ncdf4::nc_open(d18o.file)

#select the variable
var.name <- names(nc[['var']])[1] #be sure this is the value you want

summary(nc$dim$lon$vals) #if longitude is 0-360 needs to be rotated
tunits <- ncdf4::ncatt_get(nc, "time", "units")
print(tunits)

ncdf4::nc_close(nc)
```


To save multiple R objects to one file (May not want to do this)

```{r}
# Saving on object in RData format
save(data1, file = "data.RData")
# Save multiple objects
save(data1, data2, file = "data.RData")
# To load the data again
load("data.RData") #Nope. readRDS()
```

```{r}
d18o <- readRDS("Rdata/d18o.rds")
wind10 <- readRDS("Rdata/wind10.rds")
```


This is just a single variable over time
```{r}
time <- 1:nlayers(d18o)
fun <- function(x) { lm(x ~ time)$coefficients[2] }
x <- calc(d18o, fun)
plot(d18o)
```

Two variables: 
-Perform this for each variable with d18o
-change to gg plot to add map?
```{r}
corrs <- corLocal(d18o, wind10, method = "pearson")
plot(corrs)
```

```{r}
MRD_corrs <- data.frame()
```

```{r}
MRD_corrs[8,1] <- "wind10"
MRD_corrs[8,2] <- corrs[3,2]
```

```{r}
write.csv(MRD_corrs,"MRD_corrs.csv", row.names = FALSE)
```


Find the cell for TAS

```{r}
wiso_mr <- extract_xy(145.527, -41.837, corrs, "MtRead")
wiso_mr
```


next steps:
-Experiment with this function/other functions (MLR?)
-Determine which influence the most, and use what we know about d18o to see if that makes sense
-Turn into multple variable regression? Maybe unnecessary
-Turn into moving-window (part 2)

```{r}
test1 <- raster()
```

```{r}
ncell(test1)
```



```{r}
test <- raster(ncol=10, nrow=10)
vals <- 1:ncell(test)
test <- setValues(test, vals)
```

```{r}
plot(test)
```

Crop netcdf data to ocean extent
gather ncell()
create an empty raster of the same number of cells, same extent
extract 18o at MRD through time.
extract the values at each variable for each cell through time.
Correlate them. Assign the R2 value to each cell

OR

as.array(raster)
(MAYBE abind if needed)
Extract 18o at MRD through time <- make a file
correlate arrays with 18o along Z axis (time)
End up with R2 and p-value arrays
Convert them to rasters

Do this for other files:
```{r}
ar.18o <- as.array(d18o)
ar.wind10 <- as.array(wind10)
```

Dimensions: 1:4 (lat), 1:5 (long), 1:1692 (months. 1692/12 = 141 years)

```{r}
ar.18o[,,1]
```
MRD is [3,2,]


Extract a sequence for JUST Mount Read:
```{r}
MRD_18o <- ar.18o[3,2,]
```

```{r}
apply(ar.wind10, 1:2, cor, MRD_18o)
```

```{r}
apply(ar.wind10, 1:2, rcorr, MRD_18o, type="pearson")
```

This is in list form basically. The cells go like this

1   5   9   13  17
2   6   10  14  18
3   7   11  15  19
4   8   12  16  20

```{r}
z <- apply(ar.wind10, 1:2, rcorr, MRD_18o, type="pearson")
```

correlation = z[[x]][[1]][2]
significance = z[[x]][[3]][2]

Change (4,5) to new extent:

```{r}
corr = array(0, dim=c(4,5) )
sig = array(0, dim=c(4,5) )
```

Change 20 to number of cells in new extent:

```{r}
for (x in 1:20)
{
corr[x] <- z[[x]][[1]][2]
sig[x] <- z[[x]][[3]][2]
}
```

```{r}
sig
```

```{r}
l <- list(corr, sig)
a <- do.call(rbind, l)
library(abind)
a <- abind(l, along=3)
a
```

Change this brick call to get correct resolution, extent, etc

```{r}
r <- brick(a)
r
```

Next steps:
-Crop (non-d18o) files to Oceanic extent
-Run above correlation functions
-Convert corr and sig arrays to raster files
-Plotting, masking
Products:
 Combined corr/sig raster bricks for each variable
 Sig-masked corr raster files

samPC.p[samPC.p > 0.05] <- NA #mask out insignificant values
samNC.p[samNC.p > 0.05] <- NA
masked.p <- raster::mask(samPCr, samPC.p)
masked.n <- raster::mask(samNCr, samNC.p)


